version: 1.0

input:
  - recipient
  - owner

vars:
  - beertab: null
  - key: "system.beertab.{{ ctx().owner }}"

tasks:
  get_tab:
    action: st2.kv.get
    input:
      key: "{{ ctx().key }}"
    next:
      # beer tab was retrieved out of the key/value store
      - when: "{{ succeeded() }}"
        publish:
          - kv_beertab: "{{ result().result }}"
        do:
          - add_beer_to_tab
      # beer tab didn't exist in the k/v store, create a new one
      - when: "{{ failed() }}"
        publish:
          - kv_beertab:
              "{{ ctx().recipient }}": 0
        do:
          - add_beer_to_tab
              
  add_beer_to_tab:
    action: beertab.modify
    input:
      beertab: "{{ ctx().kv_beertab }}"
      recipient: "{{ ctx().recipient }}"
      owner: "{{ ctx().owner }}"
      operation: add
    next:
      - when: "{{ succeeded() }}"
        publish:
          - beertab: "{{ result().result }}"
        do:
          - save_tab

  save_tab:
    action: st2.kv.set_object
    input:
      key: "{{ ctx().key }}"
      value: "{{ ctx().beertab }}"

output:
  - beertab: "{{ ctx().beertab }}"
