version: 1.0

input:
  - person
  - user
  - beertab: null

tasks:
  get_tab:
    action: st2.kv.get
    input:
      key: "system.beertab.{{ ctx().user }}"
    next:
      # beer tab was retrieved out of the key/value store
      - when: "{{ succeeded() }}"
        publish:
          - beertab: "{{ result() }}"
      # create beer tab if it doesn't exit
      - when: "{{ failed() }}"
        publish:
          - beertab:
              "{{ ctx().person }}": 0
              
  add_beer_to_tab:
    action: core.noop
    next:
      - publish:
          - beertab: "{% set _x = (ctx().beertab[ctx().person] += 1) %}{{ ctx().beertab }}"

output:
  - beertab: "{{ ctx().beertab }}"
